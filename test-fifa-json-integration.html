<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIFA JSON Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .player-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .player-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .stat-group {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ FIFA JSON Integration Test</h1>
        <p>Testing the integration of the new JSON player database provided by the user.</p>
        
        <button onclick="runTests()">Run Tests</button>
        <button onclick="clearResults()">Clear Results</button>
        
        <div id="results"></div>
    </div>

    <script type="module">
        import { FIFADataService } from './fifaDataService.js';

        window.runTests = async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info test-section">üîÑ Running tests...</div>';

            try {
                // Test 1: Load database
                await testLoadDatabase(resultsDiv);
                
                // Test 2: Check database size
                await testDatabaseSize(resultsDiv);
                
                // Test 3: Search for known players
                await testKnownPlayers(resultsDiv);
                
                // Test 4: Test data structure
                await testDataStructure(resultsDiv);
                
                // Test 5: Test fuzzy matching
                await testFuzzyMatching(resultsDiv);

                appendResult(resultsDiv, 'success', '‚úÖ All tests completed!');
            } catch (error) {
                appendResult(resultsDiv, 'error', `‚ùå Test failed: ${error.message}`);
            }
        };

        async function testLoadDatabase(resultsDiv) {
            appendResult(resultsDiv, 'info', '<h3>Test 1: Loading Database</h3>');
            
            try {
                const loaded = await FIFADataService.loadDatabase();
                if (loaded) {
                    appendResult(resultsDiv, 'success', '‚úÖ Database loaded successfully from JSON');
                } else {
                    appendResult(resultsDiv, 'error', '‚ö†Ô∏è Database loaded from fallback (JSON load failed)');
                }
            } catch (error) {
                appendResult(resultsDiv, 'error', `‚ùå Database load failed: ${error.message}`);
                throw error;
            }
        }

        async function testDatabaseSize(resultsDiv) {
            appendResult(resultsDiv, 'info', '<h3>Test 2: Database Size</h3>');
            
            const players = await FIFADataService.getAvailablePlayers();
            const count = players.length;
            
            if (count > 10) {
                appendResult(resultsDiv, 'success', `‚úÖ Database contains ${count} players (expected > 10)`);
            } else {
                appendResult(resultsDiv, 'error', `‚ùå Database only contains ${count} players (fallback data?)`);
            }
            
            // Show first few players
            const firstPlayers = players.slice(0, 5);
            appendResult(resultsDiv, 'info', `First 5 players: ${firstPlayers.join(', ')}`);
        }

        async function testKnownPlayers(resultsDiv) {
            appendResult(resultsDiv, 'info', '<h3>Test 3: Known Players Search</h3>');
            
            const testPlayers = ['Erling Haaland', 'Kylian Mbapp√©', 'Lionel Messi'];
            
            for (const playerName of testPlayers) {
                try {
                    const playerData = await FIFADataService.getPlayerData(playerName, { useLiveData: false });
                    
                    if (playerData && playerData.found) {
                        appendResult(resultsDiv, 'success', `‚úÖ Found ${playerName} (Source: ${playerData.source})`);
                        
                        // Display player card
                        displayPlayerCard(resultsDiv, playerData);
                    } else {
                        appendResult(resultsDiv, 'error', `‚ùå ${playerName} not found`);
                    }
                } catch (error) {
                    appendResult(resultsDiv, 'error', `‚ùå Error searching for ${playerName}: ${error.message}`);
                }
            }
        }

        async function testDataStructure(resultsDiv) {
            appendResult(resultsDiv, 'info', '<h3>Test 4: Data Structure Validation</h3>');
            
            try {
                const playerData = await FIFADataService.getPlayerData('Erling Haaland', { useLiveData: false });
                
                if (!playerData) {
                    throw new Error('No player data returned');
                }

                // Check required fields
                const requiredFields = ['overall', 'potential', 'positions', 'age', 'height', 'weight', 'pace', 'shooting', 'passing', 'dribbling', 'defending', 'physical'];
                const missingFields = requiredFields.filter(field => playerData[field] === undefined);
                
                if (missingFields.length === 0) {
                    appendResult(resultsDiv, 'success', '‚úÖ All required fields present');
                } else {
                    appendResult(resultsDiv, 'error', `‚ùå Missing fields: ${missingFields.join(', ')}`);
                }

                // Check skills object
                if (playerData.skills && typeof playerData.skills === 'object') {
                    const skillCount = Object.keys(playerData.skills).length;
                    appendResult(resultsDiv, 'success', `‚úÖ Skills object contains ${skillCount} skills`);
                } else {
                    appendResult(resultsDiv, 'error', '‚ùå Skills object missing or invalid');
                }

                // Check SoFIFA integration data
                if (playerData.sofifaId && playerData.sofifaUrl) {
                    appendResult(resultsDiv, 'success', `‚úÖ SoFIFA integration data present (ID: ${playerData.sofifaId})`);
                } else {
                    appendResult(resultsDiv, 'error', '‚ùå SoFIFA integration data missing');
                }

            } catch (error) {
                appendResult(resultsDiv, 'error', `‚ùå Data structure test failed: ${error.message}`);
            }
        }

        async function testFuzzyMatching(resultsDiv) {
            appendResult(resultsDiv, 'info', '<h3>Test 5: Fuzzy Matching</h3>');
            
            const fuzzyTests = [
                { search: 'Haaland', expected: 'Erling Haaland' },
                { search: 'Mbappe', expected: 'Kylian Mbapp√©' },
                { search: 'messi', expected: 'Lionel Messi' }
            ];
            
            for (const test of fuzzyTests) {
                try {
                    const playerData = await FIFADataService.getPlayerData(test.search, { useLiveData: false });
                    
                    if (playerData && playerData.found && (playerData.suggestedName === test.expected || playerData.searchName === test.search)) {
                        appendResult(resultsDiv, 'success', `‚úÖ Fuzzy match: "${test.search}" ‚Üí "${playerData.suggestedName || 'exact match'}" (Source: ${playerData.source})`);
                    } else if (playerData && playerData.found) {
                        appendResult(resultsDiv, 'info', `‚ÑπÔ∏è Different match: "${test.search}" ‚Üí "${playerData.suggestedName || 'exact match'}"`);
                    } else {
                        appendResult(resultsDiv, 'error', `‚ùå No fuzzy match found for "${test.search}"`);
                    }
                } catch (error) {
                    appendResult(resultsDiv, 'error', `‚ùå Fuzzy test failed for "${test.search}": ${error.message}`);
                }
            }
        }

        function displayPlayerCard(resultsDiv, playerData) {
            const cardHtml = `
                <div class="player-card">
                    <h4>${playerData.searchName} ${playerData.suggestedName ? `(${playerData.suggestedName})` : ''}</h4>
                    <div class="player-stats">
                        <div class="stat-group">
                            <strong>Basic Info</strong><br>
                            Overall: ${playerData.overall}<br>
                            Potential: ${playerData.potential}<br>
                            Age: ${playerData.age}<br>
                            Positions: ${playerData.positions.join(', ')}<br>
                            Nationality: ${playerData.nationality}
                        </div>
                        <div class="stat-group">
                            <strong>Physical</strong><br>
                            Height: ${playerData.height}cm<br>
                            Weight: ${playerData.weight}kg<br>
                            Foot: ${playerData.foot}<br>
                            Weak Foot: ${playerData.weakFoot}‚≠ê<br>
                            Skill Moves: ${playerData.skillMoves}‚≠ê
                        </div>
                        <div class="stat-group">
                            <strong>Attributes</strong><br>
                            Pace: ${playerData.pace}<br>
                            Shooting: ${playerData.shooting}<br>
                            Passing: ${playerData.passing}<br>
                            Dribbling: ${playerData.dribbling}<br>
                            Defending: ${playerData.defending}<br>
                            Physical: ${playerData.physical}
                        </div>
                        <div class="stat-group">
                            <strong>Integration</strong><br>
                            SoFIFA ID: ${playerData.sofifaId || 'N/A'}<br>
                            Data Source: ${playerData.source}<br>
                            Work Rates: ${playerData.workrates}<br>
                            ${playerData.sofifaUrl ? `<a href="${playerData.sofifaUrl}" target="_blank">SoFIFA Profile</a>` : ''}
                        </div>
                    </div>
                </div>
            `;
            appendResult(resultsDiv, 'info', cardHtml);
        }

        function appendResult(resultsDiv, type, content) {
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = content;
            resultsDiv.appendChild(div);
        }

        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            setTimeout(runTests, 1000);
        });
    </script>
</body>
</html>