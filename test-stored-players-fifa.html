<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: SoFIFA f√ºr alle eingespeicherten Spieler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .console-output {
            background: #1a1a1a;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .player-card {
            transition: transform 0.2s ease;
        }
        .player-card:hover {
            transform: translateY(-2px);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg p-6 mb-8">
            <h1 class="text-3xl font-bold mb-2">üß™ Test: SoFIFA f√ºr alle eingespeicherten Spieler</h1>
            <p class="text-lg opacity-90">Testen der neuen Funktionalit√§t f√ºr alle Datenbanksspieler</p>
        </div>

        <!-- Controls -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üéÆ Test Controls</h2>
            <div class="flex flex-wrap gap-4">
                <button onclick="testDatabaseConnection()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition">
                    üìä Test Database Connection
                </button>
                <button onclick="loadAllStoredPlayers()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition">
                    üîÑ Load All Stored Players
                </button>
                <button onclick="processWithSofifa()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium transition">
                    üåê Process with SoFIFA
                </button>
                <button onclick="clearResults()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-medium transition">
                    üóëÔ∏è Clear Results
                </button>
            </div>
        </div>

        <!-- Results -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Player Results -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">üë• Player Results</h2>
                <div id="playerResults" class="space-y-2">
                    <p class="text-gray-500">Klicke auf "Load All Stored Players" um zu starten</p>
                </div>
            </div>

            <!-- Statistics -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">üìà Statistics</h2>
                <div id="statisticsResults">
                    <p class="text-gray-500">Keine Statistiken verf√ºgbar</p>
                </div>
            </div>
        </div>

        <!-- Console Output -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">üñ•Ô∏è Console Output</h2>
            <div id="consoleOutput" class="console-output p-4 rounded h-64 overflow-y-auto">
                <div>üñ•Ô∏è Console bereit...</div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg p-8 flex flex-col items-center">
                <div class="loading-spinner mb-4"></div>
                <div class="text-lg font-semibold">Processing...</div>
                <div id="loadingText" class="text-gray-600">Loading stored players...</div>
            </div>
        </div>
    </div>

    <!-- Import the modules we need -->
    <script type="module">
        // Import the FIFA service (adjust path as needed)
        import { FIFADataService } from './src/utils/fifaDataService.js';
        import { getAllPlayers } from './data.js';

        // Make them globally available for the buttons
        window.FIFADataService = FIFADataService;
        window.getAllPlayers = getAllPlayers;

        // Store results for display
        window.lastResults = null;

        // Console logging override
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        function addToConsole(message, type = 'log') {
            const output = document.getElementById('consoleOutput');
            const div = document.createElement('div');
            div.className = type === 'error' ? 'text-red-400' : type === 'warn' ? 'text-yellow-400' : 'text-green-400';
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        console.log('‚úÖ FIFA Test Module loaded');
    </script>

    <script>
        function showLoading(show, text = 'Processing...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (show) {
                loadingText.textContent = text;
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        async function testDatabaseConnection() {
            console.log('üß™ Testing database connection...');
            showLoading(true, 'Testing database connection...');
            
            try {
                const players = await getAllPlayers();
                console.log(`‚úÖ Database connection successful. Found ${players.length} players.`);
                
                document.getElementById('playerResults').innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                        ‚úÖ Database connection successful<br>
                        üìä Found ${players.length} players in database
                    </div>
                `;
            } catch (error) {
                console.error('‚ùå Database connection failed:', error.message);
                document.getElementById('playerResults').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        ‚ùå Database connection failed: ${error.message}
                    </div>
                `;
            }
            
            showLoading(false);
        }

        async function loadAllStoredPlayers() {
            console.log('üìã Loading all stored players...');
            showLoading(true, 'Loading stored players...');
            
            try {
                const players = await getAllPlayers();
                console.log(`‚úÖ Loaded ${players.length} players from database`);
                
                let html = '';
                if (players.length === 0) {
                    html = '<div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">‚ö†Ô∏è No players found in database</div>';
                } else {
                    html = `<div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4">
                        üìä Loaded ${players.length} players from database
                    </div>`;
                    
                    players.forEach(player => {
                        html += `
                            <div class="player-card bg-gray-50 border rounded p-3 mb-2">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <strong>${player.name}</strong>
                                        <span class="text-gray-600">(${player.team || 'No team'})</span>
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        ${player.position || 'No position'} | Value: ‚Ç¨${player.value || 0}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('playerResults').innerHTML = html;
                window.currentPlayers = players;
                
            } catch (error) {
                console.error('‚ùå Error loading players:', error.message);
                document.getElementById('playerResults').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        ‚ùå Error loading players: ${error.message}
                    </div>
                `;
            }
            
            showLoading(false);
        }

        async function processWithSofifa() {
            console.log('üåê Processing all stored players with SoFIFA...');
            showLoading(true, 'Processing with SoFIFA...');
            
            try {
                const results = await FIFADataService.processAllStoredPlayers({
                    useLiveData: true,
                    batchSize: 2,
                    includeStatistics: true
                });
                
                console.log(`‚úÖ Processing complete: ${results.totalCount} players processed`);
                window.lastResults = results;
                
                // Display players
                let html = `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                    ‚úÖ Processed ${results.totalCount} players in ${results.processingTime}
                </div>`;
                
                results.players.forEach(player => {
                    const fifaData = player.fifaData;
                    const overall = fifaData?.overall || 'N/A';
                    const source = fifaData?.source || 'unknown';
                    
                    html += `
                        <div class="player-card bg-gray-50 border rounded p-3 mb-2">
                            <div class="flex justify-between items-center">
                                <div>
                                    <strong>${player.name}</strong>
                                    <span class="text-gray-600">(${player.team || 'No team'})</span>
                                    ${player.enhanced ? '‚úÖ' : '‚ùå'}
                                </div>
                                <div class="text-sm">
                                    <span class="font-semibold">OVR: ${overall}</span> | 
                                    <span class="text-gray-500">${source}</span>
                                </div>
                            </div>
                            ${fifaData && fifaData.positions ? `<div class="text-xs text-gray-600 mt-1">Positions: ${fifaData.positions.join(', ')}</div>` : ''}
                        </div>
                    `;
                });
                
                document.getElementById('playerResults').innerHTML = html;
                
                // Display statistics
                if (results.statistics) {
                    const stats = results.statistics;
                    document.getElementById('statisticsResults').innerHTML = `
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span>Total Players:</span><span class="font-semibold">${stats.total}</span></div>
                            <div class="flex justify-between"><span>Enhanced:</span><span class="font-semibold text-green-600">${stats.enhanced}</span></div>
                            <div class="flex justify-between"><span>Failed:</span><span class="font-semibold text-red-600">${stats.failed}</span></div>
                            <div class="flex justify-between"><span>Success Rate:</span><span class="font-semibold">${stats.successRate}</span></div>
                            <div class="flex justify-between"><span>With Live Data:</span><span class="font-semibold">${stats.withLiveData}</span></div>
                            <div class="flex justify-between"><span>With Mock Data:</span><span class="font-semibold">${stats.withMockData}</span></div>
                            <div class="flex justify-between"><span>Generated Data:</span><span class="font-semibold">${stats.withGeneratedData}</span></div>
                            <hr class="my-2">
                            <div class="text-xs text-gray-600">
                                <strong>Source Breakdown:</strong><br>
                                ${Object.entries(stats.sourceBreakdown).map(([source, count]) => `${source}: ${count}`).join('<br>')}
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('‚ùå Error processing with SoFIFA:', error.message);
                document.getElementById('playerResults').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        ‚ùå Error processing with SoFIFA: ${error.message}
                    </div>
                `;
            }
            
            showLoading(false);
        }

        function clearResults() {
            document.getElementById('playerResults').innerHTML = '<p class="text-gray-500">Results cleared</p>';
            document.getElementById('statisticsResults').innerHTML = '<p class="text-gray-500">Keine Statistiken verf√ºgbar</p>';
            document.getElementById('consoleOutput').innerHTML = '<div>üñ•Ô∏è Console cleared...</div>';
            window.lastResults = null;
            window.currentPlayers = null;
            console.log('üóëÔ∏è Results cleared');
        }
    </script>
</body>
</html>